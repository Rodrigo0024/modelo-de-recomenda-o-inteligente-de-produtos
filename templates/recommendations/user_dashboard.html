{% extends 'recommendations/base.html' %}
{% load static %}

{% block title %}Meu Dashboard - Sistema de Recomenda√ß√µes{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1>üìä Meu Dashboard</h1>
                <div>
                    <a href="{% url 'recommendations:product_explorer' %}" class="btn btn-outline-primary me-2">
                        üõçÔ∏è Explorar Produtos
                    </a>
                    <a href="{% url 'recommendations:train_recommender' %}" class="btn btn-outline-warning">
                        üéØ Treinar Modelo
                    </a>
                </div>
            </div>
            <p class="text-muted">Acompanhe suas atividades e estat√≠sticas no sistema</p>
        </div>
    </div>

    <!-- Estat√≠sticas Principais -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-primary">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-primary">üëÅÔ∏è Visualiza√ß√µes</h5>
                            <h2 class="text-primary">{{ total_views }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-eye fa-2x text-primary"></i>
                        </div>
                    </div>
                    <p class="card-text text-muted small">Produtos visualizados</p>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-success">üíù Lista de Desejos</h5>
                            <h2 class="text-success">{{ wishlist_count }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-heart fa-2x text-success"></i>
                        </div>
                    </div>
                    <p class="card-text text-muted small">Produtos favoritados</p>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-warning">‚≠ê Avalia√ß√µes</h5>
                            <h2 class="text-warning">{{ ratings_count }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-star fa-2x text-warning"></i>
                        </div>
                    </div>
                    <p class="card-text text-muted small">Produtos avaliados</p>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h5 class="card-title text-info">üìà Intera√ß√µes</h5>
                            <h2 class="text-info">{{ total_interactions }}</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-line fa-2x text-info"></i>
                        </div>
                    </div>
                    <p class="card-text text-muted small">Total de intera√ß√µes</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Coluna Esquerda - Atividades Recentes -->
        <div class="col-lg-8 mb-4">
            <!-- Atividades Recentes -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üïí Atividades Recentes</h5>
                </div>
                <div class="card-body">
                    {% if recent_interactions %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Tipo</th>
                                    <th>Avalia√ß√£o</th>
                                    <th>Data</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for interaction in recent_interactions %}
                                <tr>
                                    <td>
                                        <a href="{% url 'recommendations:product_detail' interaction.product.id %}" class="text-decoration-none">
                                            {{ interaction.product.name }}
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if interaction.interaction_type == 'view' %}bg-info
                                            {% elif interaction.interaction_type == 'wishlist' %}bg-success
                                            {% elif interaction.interaction_type == 'rating' %}bg-warning
                                            {% else %}bg-secondary{% endif %}">
                                            {% if interaction.interaction_type == 'view' %}üëÅÔ∏è Visualiza√ß√£o
                                            {% elif interaction.interaction_type == 'wishlist' %}üíù Lista de Desejos
                                            {% elif interaction.interaction_type == 'rating' %}‚≠ê Avalia√ß√£o
                                            {% else %}{{ interaction.interaction_type }}{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if interaction.rating %}
                                        <div class="rating-stars-small">
                                            {% for i in "12345" %}
                                            <span class="{% if forloop.counter <= interaction.rating %}text-warning{% else %}text-muted{% endif %}">‚òÖ</span>
                                            {% endfor %}
                                        </div>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-muted small">{{ interaction.created_at|date:"d/m/Y H:i" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-history fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Nenhuma atividade registrada ainda.</p>
                        <a href="{% url 'recommendations:product_explorer' %}" class="btn btn-primary">
                            üõçÔ∏è Explorar Produtos
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Produtos Mais Visualizados -->
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">üëÄ Meus Produtos Mais Visualizados</h5>
                </div>
                <div class="card-body">
                    {% if most_viewed_products %}
                    <div class="row">
                        {% for product in most_viewed_products %}
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="row g-0">
                                    <div class="col-4">
                                        {% if product.image_url %}
                                        <img src="{{ product.image_url }}" class="img-fluid rounded-start h-100 w-100" alt="{{ product.name }}" style="object-fit: cover;">
                                        {% else %}
                                        <div class="bg-light d-flex align-items-center justify-content-center h-100 w-100">
                                            <span class="text-muted small">üñºÔ∏è Sem imagem</span>
                                        </div>
                                        {% endif %}
                                    </div>
                                    <div class="col-8">
                                        <div class="card-body">
                                            <h6 class="card-title">{{ product.name|truncatechars:30 }}</h6>
                                            <p class="card-text small text-muted">{{ product.category }}</p>
                                            <p class="card-text fw-bold text-success">R$ {{ product.price }}</p>
                                            <div class="d-flex justify-content-between align-items-center small text-muted">
                                                <span>üëÅÔ∏è {{ product.view_count }} views</span>
                                                {% if product.rating %}
                                                <span>‚≠ê {{ product.rating }}</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-eye-slash fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Voc√™ ainda n√£o visualizou nenhum produto.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Coluna Direita - Estat√≠sticas e Recomenda√ß√µes -->
        <div class="col-lg-4">
            <!-- Estat√≠sticas por Categoria -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">üìÇ Intera√ß√µes por Categoria</h5>
                </div>
                <div class="card-body">
                    {% if category_stats %}
                    <div class="list-group list-group-flush">
                        {% for stat in category_stats %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="fw-bold">{{ stat.category }}</span>
                            <div>
                                <span class="badge bg-primary rounded-pill me-1">üëÅÔ∏è {{ stat.view_count }}</span>
                                <span class="badge bg-success rounded-pill me-1">üíù {{ stat.wishlist_count }}</span>
                                <span class="badge bg-warning rounded-pill">‚≠ê {{ stat.rating_count }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-chart-pie fa-2x text-muted mb-2"></i>
                        <p class="text-muted small">Nenhuma intera√ß√£o por categoria</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Status do Modelo -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">ü§ñ Status do Modelo</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Modelo Treinado:</span>
                        <span class="badge {% if model_trained %}bg-success{% else %}bg-warning{% endif %}">
                            {% if model_trained %}‚úÖ Ativo{% else %}‚è≥ Pendente{% endif %}
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Intera√ß√µes M√≠nimas:</span>
                        <span class="badge {% if total_interactions >= 10 %}bg-success{% else %}bg-warning{% endif %}">
                            {{ total_interactions }}/10
                        </span>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                        <span>Recomenda√ß√µes:</span>
                        <span class="badge {% if user_recommendations %}bg-success{% else %}bg-secondary{% endif %}">
                            {% if user_recommendations %}{{ user_recommendations|length }} dispon√≠veis{% else %}Nenhuma{% endif %}
                        </span>
                    </div>
                    
                    {% if not model_trained or total_interactions < 10 %}
                    <div class="alert alert-warning mt-3 mb-0">
                        <small>
                            <strong>üí° Dica:</strong> 
                            {% if total_interactions < 10 %}
                            Interaja com mais produtos para melhorar as recomenda√ß√µes.
                            {% else %}
                            Treine o modelo para ativar as recomenda√ß√µes personalizadas.
                            {% endif %}
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- A√ß√µes R√°pidas -->
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">‚ö° A√ß√µes R√°pidas</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{% url 'recommendations:train_recommender' %}" class="btn btn-warning">
                            üéØ Treinar Modelo de Recomenda√ß√£o
                        </a>
                        <a href="{% url 'recommendations:product_explorer' %}" class="btn btn-outline-primary">
                            üõçÔ∏è Explorar Mais Produtos
                        </a>
                        <a href="{% url 'recommendations:user_recommendations' %}" class="btn btn-outline-success">
                            üìã Ver Minhas Recomenda√ß√µes
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìä Dashboard carregado');
    
    // Atualizar estat√≠sticas periodicamente (opcional)
    function updateStats() {
        console.log('üîÑ Atualizando estat√≠sticas...');
        // Aqui voc√™ pode adicionar chamadas AJAX para atualizar estat√≠sticas em tempo real
    }
    
    // Atualizar a cada 30 segundos (opcional)
    // setInterval(updateStats, 30000);
});
</script>

<style>
.rating-stars-small {
    font-size: 0.8rem;
}
.card {
    transition: transform 0.2s ease;
}
.card:hover {
    transform: translateY(-2px);
}
.list-group-item {
    border: none;
    padding: 0.75rem 0;
}
.badge {
    font-size: 0.7rem;
}
</style>
{% endblock %}